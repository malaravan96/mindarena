/**
 * Downloads Twemoji SVGs for the picker emojis and generates assets/twemoji/emojiMap.ts
 *
 * Usage:  npx tsx scripts/generate-emoji-map.ts
 */
import * as fs from 'fs';
import * as path from 'path';
import * as https from 'https';

// All emojis from EmojiPicker categories + quick reactions
const EMOJIS = [
  // Quick reactions
  'ðŸ‘','ðŸ”¥','ðŸ§ ','âš¡','ðŸ˜‚','â¤ï¸',
  // Smileys
  'ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ¤£','ðŸ˜‚','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Š','ðŸ˜‡','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','ðŸ˜š','ðŸ˜™','ðŸ¥²','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ¤«',
  // People
  'ðŸ‘‹','ðŸ¤š','ðŸ–','âœ‹','ðŸ––','ðŸ‘Œ','ðŸ¤Œ','âœŒï¸','ðŸ¤ž','ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ–•','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ«¶','ðŸ‘','ðŸ¤²','ðŸ¤',
  // Nature
  'ðŸ¶','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¦Š','ðŸ»','ðŸ¼','ðŸ¨','ðŸ¯','ðŸ¦','ðŸ®','ðŸ·','ðŸ¸','ðŸµ','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ”','ðŸ§','ðŸ¦','ðŸ¤','ðŸ¦†','ðŸ¦…','ðŸ¦‰','ðŸ¦‡','ðŸº','ðŸ—','ðŸ´','ðŸ¦„',
  // Food
  'ðŸŽ','ðŸŠ','ðŸ‹','ðŸ‡','ðŸ“','ðŸˆ','ðŸ’','ðŸ‘','ðŸ¥­','ðŸ','ðŸ¥¥','ðŸ¥','ðŸ…','ðŸ†','ðŸ¥‘','ðŸ¥¦','ðŸ¥¬','ðŸ¥’','ðŸŒ½','ðŸŒ¶','ðŸ¥•','ðŸ§„','ðŸ§…','ðŸ¥”','ðŸ ','ðŸ¥','ðŸ¥¯','ðŸž','ðŸ¥–','ðŸ¥¨',
  // Activities
  'âš½','ðŸ€','ðŸˆ','âš¾','ðŸ¥Ž','ðŸŽ¾','ðŸ','ðŸ‰','ðŸ¥','ðŸŽ±','ðŸ“','ðŸ¸','ðŸ’','ðŸ¥','ðŸ‘','ðŸ','ðŸ¥…','â›³','ðŸ¹','ðŸŽ£','ðŸ¤¿','ðŸ¥Š','ðŸ¥‹','ðŸŽ½','ðŸ›¹','ðŸ›¼','ðŸ›·','â›¸','ðŸ¤º','ðŸ‹ï¸',
  // Travel
  'ðŸš—','ðŸš•','ðŸš™','ðŸšŒ','ðŸšŽ','ðŸŽ','ðŸš“','ðŸš‘','ðŸš’','ðŸš','ðŸ›»','ðŸšš','ðŸš›','ðŸšœ','ðŸ›µ','ðŸ','ðŸ›º','ðŸš²','ðŸ›´','ðŸ›¹','ðŸš‚','ðŸšƒ','ðŸš„','ðŸš…','ðŸš†','ðŸš‡','ðŸšˆ','ðŸš‰','ðŸšŠ','ðŸš',
  // Objects
  'âŒš','ðŸ“±','ðŸ’»','ðŸ–¥','ðŸ–¨','âŒ¨ï¸','ðŸ–±','ðŸ–²','ðŸ’½','ðŸ’¾','ðŸ’¿','ðŸ“€','ðŸ“·','ðŸ“¸','ðŸ“¹','ðŸŽ¥','ðŸ“½','ðŸŽž','ðŸ“ž','â˜Žï¸','ðŸ“Ÿ','ðŸ“ ','ðŸ“º','ðŸ“»','ðŸ§­','â±','â°','â²','âŒ›','â³',
  // Symbols
  'â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ–¤','ðŸ¤','ðŸ¤Ž','ðŸ’”','â£ï¸','ðŸ’•','ðŸ’ž','ðŸ’“','ðŸ’—','ðŸ’–','ðŸ’˜','ðŸ’','ðŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ðŸ•‰','âœ¡ï¸','ðŸ”¯','ðŸ•Ž','â˜¯ï¸','â˜¦ï¸','ðŸ›','â™ˆ',
];

function emojiToCodepoint(emoji: string): string {
  return [...emoji]
    .map((c) => c.codePointAt(0)!.toString(16))
    .filter((cp) => cp !== 'fe0f')
    .join('-');
}

function fetchSvg(codepoint: string): Promise<string | null> {
  const url = `https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/${codepoint}.svg`;
  return new Promise((resolve) => {
    https.get(url, (res) => {
      if (res.statusCode !== 200) {
        resolve(null);
        res.resume();
        return;
      }
      let data = '';
      res.on('data', (chunk: string) => (data += chunk));
      res.on('end', () => resolve(data));
    }).on('error', () => resolve(null));
  });
}

async function main() {
  // Deduplicate
  const unique = [...new Set(EMOJIS)];
  const entries: [string, string][] = [];
  let fetched = 0;

  for (const emoji of unique) {
    const cp = emojiToCodepoint(emoji);
    const svg = await fetchSvg(cp);
    fetched++;
    if (svg) {
      // Minify: collapse whitespace
      const minified = svg.replace(/\n/g, '').replace(/\s{2,}/g, ' ').trim();
      entries.push([cp, minified]);
      process.stdout.write(`\r  ${fetched}/${unique.length} fetched (${cp} OK)`);
    } else {
      process.stdout.write(`\r  ${fetched}/${unique.length} fetched (${cp} MISSING)`);
    }
  }

  console.log(`\n  Total: ${entries.length} SVGs`);

  const lines = entries.map(([cp, svg]) => `  '${cp}': '${svg.replace(/'/g, "\\'")}',`);
  const content = `// Auto-generated by scripts/generate-emoji-map.ts â€” DO NOT EDIT\n// Contains Twemoji SVG data for ${entries.length} emojis\n// License: CC-BY 4.0 (https://creativecommons.org/licenses/by/4.0/)\n\nexport const emojiSvgMap: Record<string, string> = {\n${lines.join('\n')}\n};\n`;

  const outPath = path.resolve(__dirname, '..', 'assets', 'twemoji', 'emojiMap.ts');
  fs.writeFileSync(outPath, content, 'utf-8');
  console.log(`  Written to ${outPath}`);
}

main().catch(console.error);
